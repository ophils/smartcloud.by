<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional">
<html><head><meta http-equiv="content-type" content="text/html" charset="utf-8">
<title>Остров пингвинов. Копируем сайт</title>
<meta name="description" lang="ru" content="Простой скрипт для копирования сайта, на примере computerra.ru">
<meta name="keywords" lang="en" content="Linux, Unix, LUG, Gomel, Belarus, ex-USSR, hacker, hacks, Debian, free software, shell, bash, textutils, awk, perl, microhack, tricks, tips, russian, computerra, softerra">
<meta name="keywords" lang="ru" content="Линукс, Юникс, Гомель, Беларусь, пользователи Линукс, хаки, хакеры, Олег П. Филон, статьи, компьютерра, софтерра">
<meta name="author" content="Олег П. Филон">
<meta name="copyright" content="&copy; FDL(C), Олег П. Филон">
<link rel="e-mail" href="mailto:smartcloud.by@gmail.com">
<meta name="date" content="2002-12-22">
<meta name="version" content="1.1">
<style type="text/css">
<!--
body, p, div, td, th, tr, form, ol, ul, li, input, textarea, select, a
	{ 	font-family: Verdana,Geneva,Arial,Helvetica,sans-serif;
		font-size: 11pt;
    }
body	{	background: white;
		margin: 3px;
    }
p 	{	display: block;
		text-align: justify;
		line-height: 120%;
		margin: 4px;
    }	
b 	{ 	font-weight: bold;
		color: blue;
    }
pre, code, tt { font: "Courier New", Courier, monospace;
		line-height: 120%;
		font-size: 11pt;
    }

a	{	font-family: Verdana,Geneva,Arial,Helvetica,sans-serif;
		font-size:12pt;
		text-decoration:underline;
		color: blue
    }
a:hover {	color: red
    }
-->
</style>
<script type="text/javascript" language=JavaScript>
<!--
newbie = new Image();
newbie.src="../img/newbie.gif";
guru = new Image();
guru.src="../img/guru.gif";
comm = new Image();
comm.src="../img/forum.gif";
about = new Image();
about.src="../img/about.gif";
-->
</script>

</head><body>
<table cellpadding=0 cellspacing=3 border=0 summary="макет страницы">
<tr valign=top><td><a href=../index.html><img src="../img/topbox.gif" alt="Остров пингвинов"></a></td>
<td height=60 bgcolor="#FFCC33"></td></tr>
<tr><td colspan=2><img src="../img/blue-line.gif" width=600 height=5
alt="- - - - - - - - - - - - - - - - - - - - - - -">
<tr valign=top><td width=131>
<img name="corner" src="../img/articles.gif" width=125 height=91 alt="Сольные выступления"><br><br>
<a href="../articles/newbie.html" onmouseover="document.corner.src='../img/newbie.gif';return true" onmouseout="document.corner.src='../img/articles.gif';return true">Для начинающих</a><br><br>
<a href="../articles/guru.html" onmouseover="document.corner.src='../img/guru.gif';return true" onmouseout="document.corner.src='../img/articles.gif';return true">Для знатоков</a><br><br>
<a href="../articles/community.html" onmouseover="document.corner.src='../img/forum.gif';return true" onmouseout="document.corner.src='../img/articles.gif';return true">Для души</a><br><br>
<a href="../articles/about.html" onmouseover="document.corner.src='../img/about.gif';return true" onmouseout="document.corner.src='../img/articles.gif';return true">О нас</a>
</td><td>

<p>
<strong>Копируем сайт</strong>
<p>
Самой первым вопросом, который нужно решить, приступая к копированию сайта
- это выбрать подходящий сайт. Легкость публикации в Сети привела к тому,
что найти достойный поставленной задачи сайт не так-то просто. Дело
не только в том, что для отыскания среди лавины информации жемчужины
сокровенного знания нужен изрядный труд. Многие вполне приличные сайты
стали настолько динамичными, завязанными на интерактивность, общение,
что копировать их нет никакого смысла. Отпадает также масса чисто
развлекательных, ориентированных только на внешние изыски сайтов -
их достаточно увидеть один раз.
<p>
Но вот мне попался на глаза сайт <a href="http://www.softerra.ru">http://www.softerra.ru</a> и,
кажется, там есть статьи, стоящие внимательного прочтения, а также
рекомендации коллегам-программистам. Некоторые рубрики, например,
<em>freeos</em>, <em>macos</em> - вполне достойны заполнить дефицит учебной
литературы в столь динамичной области, как информатика и программирование.
Так что на первый вопрос ответ найден, и мы пытаемся ответить на
следующий, не менее важный вопрос - а можно ли копировать этот сайт?
<p>
Иногда сайты, разрешённые к копированию, создают все условия для их
клонирования - например, <a href="http://www.citforum.ru">http://www.citforum.ru</a> выкладывает
на ftp-архив упакованный файл ежедневных обновлений.  На видном месте
лежит подробная инструкция, как настроить и запустить зеркало этого
уникального образовательного сайта. <a href="http://www.citforum.ru">ЦитФорум</a> стал самым первым зеркалом, которое я когда-то давно сделал,
за которым внимательно слежу уже много лет.
<p>
К счастью, объект нашего внимания, <a href="http://www.softerra.ru">http://www.softerra.ru</a>,
относится к копированию довольно либерально. На сайте прямо указаны
условия, на которых можно копировать материалы сайта.  Так как они
непосредственно относятся к постановке задачи, приведу 5 пунктов правил,
касающихся копирования статей.
<p>
&lt;cite&gt;
<ol>
<li> При использовании статьи необходимо сохранять оригинальное название
статьи, указывать имя, фамилию и e-mail автора, а также предварять текст
самой статьи сообщением: &lt;&lt;Первоначально опубликовано
на сайте "Софтерра", www.softerra.ru&gt;&gt;.
<li> Использовать статьи разрешается не ранее, чем через пять рабочих
дней после их появления на нашем сайте. Дату публикации любой статьи вы
увидите рядом с ее заголовком.
<li> Если в конце статьи приведены ссылки на близкие по теме материалы
на нашем сайте, то вы должны сохранять их при размещении статьи на
вашем сайте.
<li> В конце статьи вы обязательно должны указать &lt;&lt;Copyright 
"Софтерра", &lt;a href="http://www.softerra.ru"&gt;www.softerra.ru&lt;/a&gt;,
&lt;a href="mailto:inform@softerra.ru"&gt;inform@softerra.ru&lt;/A&gt; &gt;&gt;.
<li> И, наконец, самое важное: в конце статьи вы <strong>обязательно</strong>
должны разместить блок из как минимум трех анонсов последних статей на
сайте "Софтерры". Для этого поместите нижеприведенный код после завершения
текста статьи. Считайте это скромной оплатой труда наших авторов.
</ol>
&lt;/cite&gt;
<p>
Сделаем в этом месте небольшое лирическое отступление. Конечно, любое
требование владельца авторских прав является законным.  Если бы автор
web-страницы вдруг потребовал: "для того, чтобы читать моё сочинение
дальше, немедленно переведите на мой счёт Q рублей" (имеется в виду
Q большое) - это его условие также было бы вполне законно. Но такое
требование было бы неразумно, так как любой здравомыслящий _И_ (логическое
И) честный человек вряд ли бы дочитал его страницу до конца. Правила
же, составленные редакцией "Софтерры", вполне разумны, мы может только
пожелать им успеха в нелёгком бизнесе web-издания.
<p>
Замечу также, что по мнению многих уважаемых хакеров, в частности,
Ричарда М. Столмена, сообщества разработчиков Debian - отсутствие явного
разрешения на копирование программы или документа равносильно запрету на
копирование. Копировать любое авторское произведение можно только если
автор или владелец прав на него прямо дал такое разрешение, и только на
указанных автором условиях.
<p>
Теперь мы приступим к изучению сайта <a href="http://www.softerra.ru">http://www.softerra.ru</a>,
чтобы узнать, а можно ли как-то запрограммировать процесс копирования ?
Конечно, хорошо настроенный кэш позволит, вволю пощёлкав кнопками,
получить более-менее представительное подмножество сайта где-то в
глубине каталогов вашего диска. Эти разрозненные страницы вряд ли,
однако, можно назвать копией сайта.
<p>
Поэтому выберем отдельные рубрики, представляющие интерес - для примера,
каталог <em>/freeos</em>, и изучим его содержимое. Оказывается, на страницах
<em>/freeos/pageN.html</em> хранится список опубликованных статей. Ручное
копирование этих страниц нам совершенно не интересно, так что пора
подумать о хорошем инстументе для работы.
<p>
Самым удобным инструментом для общения с компьютером являются, бесспорно,
классические юниксовые средства. Вглядитесь, что за мощь скрыта в
командном процессоре <tt>bash</tt>, в языках <tt>awk</tt>, <tt>perl</tt>, в изящных
текстовых и файловых утилитах, в потоковом редакторе <tt>sed</tt>. Как хорошо
они взаимодействуют друг с другом, как гармоничен их ансамбль. Руки
так и просят потрогать эти прекрасные инструменты, ощутить их силу и
послушность. Если у вас такое же желание, можете провести небольшую
разминку, к примеру, вот с этими <a href="micro-hacks.html">микрохаками</a>.
<p>
Вот уж, воистину, такими инструментами можно и храм построить, и бороду
сбрить (хакер, устар. - тот, кто топором бреется :&gt;).
<p>
Таким образом, уяснив, что список интересующих нас статей находится на
указанных выше страницах, мы первым делом получаем эти страницы
<blockquote><pre>
... $ site=http://www.softerra.ru
... $ win2koi=ЧЮАЖДЕТЦУХИЙКЛМНОЪПЯРСФБЭШГЬЩЫВЗчюаждетцухийклмноъпярсфбэшгьщывз
... $ for i in $(seq 1 10);do snarf $site/freeos/page$i.html -|
&gt; tr $win2koi ю-ъЮ-Ъ &gt; page$i.html;done
</pre></blockquote>
<p>
Здесь я по ходу сделал перекодировку из кодовой страницы cp1251 в
принятую в моей системе КОИ-8. Если у вас принята другая кодировка,
эта операции не нужна и строка-программа упрощается. Строку для
перекодировки можно всегда получить, воспользовавшись, например,
<blockquote><pre>
... $ perl -e 'use locale;print grep/\w/,map{chr()}128..255'
</pre></blockquote>
<p>
а затем перегнав её в cp1251 любым из имеющихся перекодировщиков.
Можете смело пользоваться приведенной выше строкой, я её все равно
руками не набирал (стучу по клавишам клювом :&gt;).
<p>
По прибытии страниц с оглавлениями придётся внимательно их просмотреть
на предмет координат собственно статей. Здесь нас ждёт приятная находка -
оказывается, программисты Софтерры уже предусмотрели версии статей,
предназначенные для печати и очищенные от массы служебной и рекламной
информации. Ура, самая неприятная работа - выковыривание из html-кода
полезной информации - уже сделана. Чистые и компактные страницы хранятся
в файлах <em>/freeos/NNNNN/print.html</em>, где NNNNN, видимо, порядковый номер
статьи.
<p>
Попробуем использовать найденную регулярность и выбрать из оглавлений
точные адреса статей. Воспользуемся возможностью языка <tt>perl</tt> для отладки
и визуализации регулярных выражений.
<blockquote><pre>
... $ perl -wne 'print "$1\n" if m#href=/(\w+/\d+)/page1.html#' page*.html
</pre></blockquote>
<p>
Убедившись, что мы находим именно то, что нам надо, присвоим найденный
список каталогов переменной <tt>list</tt>. При желании этот список можно
записать в файл и подредактировать, но мы постараемся решить задачу
самыми минимальными средствами. Хотя я снова приведу эту довольно длинную
строку-программу, вы, конечно, знаете, что при работе в шелле она берётся
из <tt>history</tt> и чуть-чуть редактируется.
<blockquote><pre>
list=$(perl -wne 'print "$1\n" if m#href=/(\w+/\d+)/page1.html#' page*.html)
</pre></blockquote>
<p>
Нам желательно выбрать из адреса отдельно имена каталогов, поэтому сделаем
ещё одно отладочное действие, а именно:
<blockquote><pre>
... $ for i in $list;do n=${i##*/};d=${i%$n};echo $d $n;done
</pre></blockquote>
<p>
Эти магические знаки и скобки позволяют выбирать из слова его части
средствами самого <tt>bash</tt>'а, не привлекая без нужды посторонние средства.
Отладив выражение, дадим ему настоящее задание:
<blockquote><pre>
... $ for i in $list;do n=${i##*/};snarf $site/$i/print.html -|
&gt; tr $win2koi ю-ъЮ-Ъ &gt; $n.html;done
</pre></blockquote>
<p>
Снова попутно выполнено необязательное перекодирование. Имеющиеся на
некоторых страницах иллюстрации извлекаются с сайта Софтерры так же просто:
<blockquote><pre>
... $ perl -wne'
&gt; print "'$site'/$1\n" if m#src="/(pubimages/[^"]+\.(?:gif|jpg))"#
&gt; ' [0-9]*.html|xargs snarf
</pre></blockquote>
<p>
Мы успешно получили все заинтересовавшие нас статьи, но ещё не выполнили
перечисленных правовладельцами условий копирования. Если я хочу поместить
эти страницы у себя на сайте, а задумано было именно так, то наша процедура
копирования ещё не закончена. Как вы помните, Софтерра требует вставить
несколько дополнительных строк и ссылок. Займёмся теперь этим, заодно
опробуем в действии ещё пару утилит и слегка поправим полученные странички.
<p>
Ничто не запрещает нам удалить очень подробную информацию из
мета-тэгов - она предназначена для поисковиков, а обычной читающей
публике ничего нового не сообщает. Снова призовём <tt>perl</tt>:
<blockquote><pre>
... $ perl -i.bak -wpe's#&lt;meta name="[^&gt;]+&gt;##' *.html
</pre></blockquote>
<p>
Ключ -i.bak нужен только для подстраховки, чтобы убедиться, что регулярное
выражение составлено правильно и получено то, что хотелось. После проверки
оригинальные файлы можно смело удалить.
<blockquote><pre>
... $ rm *.bak
... $ perl -i -wpe's#src="/include/script#src="include/script#' *.html
... $ perl -i -wpe's#src="/pubimages#src="pubimages#g' *.html
... $ mkdir pubimages; mv *.gif *.jpg pubimages
</pre></blockquote>
<p>
Этими простыми операциями мы отвязали наши ссылки от корневого каталога
и переместили картинки в отдельный каталог. Теперь приступим к вставке
требуемых Софтеррой строк и ссылок. Давайте приготовим эти строки заранее,
чтобы воспользоваться трудно передаваемым в статике способом работы с
мышью drag-&amp;-drop.
<blockquote><pre>
... $ echo '&lt;p&gt;(C) Copyright "Софтерра",\
&gt; &lt;a href="http://www.softerra.ru"&gt;www.softerra.ru&lt;/a&gt;,\
&gt; &lt;a href="mailto:inform@softerra.ru"&gt;inform@softerra.ru&lt;/a&gt;.'
... $ echo '&lt;p&gt;&lt;script src="http://www.softerra.ru/\
&gt; softerra-articles-js.html?articlecount=5"&gt;&lt;/script&gt;'
</pre></blockquote>
<p>
Здесь мне пришлось разбить эти строки на несколько строк для компактности,
на самом деле это 2 длинные строки. Чуть позже я на них сошлюсь как
доп.строка1 и доп.строка2. Вставляются они в нужное место с помощью
мыши - отмечаем блок, удерживая левую кнопку, а затем вставляем в нужное
место, подведя курсор и нажав правую кнопку мыши. Вот какое длинное
описание элементарной процедуры получилось. Будем, однако, радоваться,
что обошлось без нескольких страниц скриншотов.
<p>
Место, куда мы вставим эти строки, выберем в самом конце файла,
там, где находится контекст &lt;/div&gt;&lt;br&gt;&lt;/body&gt;
<blockquote><pre>
... $ perl -i -wpe 's#&lt;/div&gt;&lt;br&gt;&lt;/body&gt;#\
&gt; доп.строка1\
&gt; доп.строка2\
&gt; &lt;/div&gt;&lt;/body&gt;#' *.html
</pre></blockquote>
<p>
В завершение выполним ещё одну операцию - названия файлов у нас какие-то
непонятные порядковые номера, что неудобно. Благо, в каждой статье есть заголовок,
давайте так и назовем каждый из файлов.
<blockquote><pre>
... $  for i in [0-9]*.html;do fn=$(grep '&lt;h1&gt;' $i|
&gt; sed 's#^.*&lt;h1&gt;\(.*\)&lt;/h1&gt;.*$#\1#;\
&gt; s/ /_/g;s/\&amp;.*;//g;s#[!?/]#~#g;s/\.*$//');\
&gt; mv $i $fn.html;done
</pre></blockquote>
<p>
Здесь нам пришлось повозиться с именами файлов - сначала извлечь заголовок,
затем заменить пробелы на знак подчёркивания, затем убрать сомнительные
знаки и лишние точки. Теперь, в основном, наша задача выполнена. Получение
и размещение отдельных файлов - script.js, print.css автоматизации
не подлежат и выполняются вручную.
<p>
P.S. Можете посмотреть <a href="copy-softerra">настоящий скрипт</a>, делающий
несколько дополнительных действий при копировании избранных каталогов
с <a href="http://www.softerra.ru">Софтерры</a>.
</td></tr><tr><td colspan=2 align=center>
<img src=../img/footer.gif border=0 usemap=#gulag alt="Олег Филон, Дм. Федорович, Ал-др Качанов">
<map name=gulag>
<area shape="rect" coords="0,10,130,25" href=../articles/articles.html alt="Статьи Олега Филона" title=ophil>
<area shape="rect" coords="0,25,51,37" href=../articles/articles.html alt="Статьи Олега Филона" title=ophil>
<area shape="rect" coords="140,25,317,40" href=http://www.stihi.ru/avtor/fedorovich alt="Литературная страница Дм. Федоровича" title=df>
<area shape="rect" coords="60,40,317,55" href=http://www.stihi.ru/avtor/fedorovich alt="Литературная страница Дм. Федоровича" title=df>
<area shape="rect" coords="290,5,440,20" href=http://www.webmascon.com alt="дизайн А. Качанова" title=community>
<area shape="rect" coords="343,20,440,38" href=http://www.webmascon.com alt="дизайн А. Качанова" title=community>
<area shape="default" href=../articles/articles.html alt="Статьи Олега Филона" title=ophil>
</map></td></tr>
</table>
</body>
</html>
